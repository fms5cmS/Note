
OS 会在栈空间的尾部设置一个禁止读写的页，一旦栈增长到尾部，OS 就可以通过中断探知程序在访问栈末端，从而返回 StackOverflow。

OS 内核在运行时也是需要栈的，这个栈被称为内核栈，只有高权限的内核代码才能访问它。而内核态和用户态的切换也依赖于两个栈的切换。

# 执行单元

执行单元是指 CPU 调度和分派的基本单位，它是一个 CPU 能正常运行的基本单元。执行单元是可以停下来的，只要能把 CPU 状态（其实就是寄存器的值）全部保存起来，等到这个执行单元再被调度的时候，就把状态恢复过来就行了。我们把这种保存状态，挂起，恢复执行，恢复状态的完整过程，称为执行单元的调度 (Scheduling)。

常见的执行单元有进程、线程和协程三种！

栈切换的核心就是栈指针 rsp 寄存器的切换，只要我们想办法把 rsp 切换了就相当于换了执行单元的上下文环境。

- 进程与线程

当运行一个可执行程序的时候，操作系统就会启动一个进程。进程会被操作系统管理和调度，被调度到的进程就可以独占 CPU 了。

进程有自己独立的内存空间和页表，以及文件表等等各种私有资源，如果使用多进程系统，让多个任务并发执行，那么它所占用的资源就会比较多。线程的出现解决了这个问题。

同一个进程中的线程则共享该进程的内存空间，文件表，文件描述符等资源，它与同一个进程的其他线程共享资源分配。除了共享的资源，每个线程也有自己的私有空间，这就是线程的栈。线程在执行函数调用的时候，会在自己的线程栈里创建函数栈帧。

根据上面的特点，通常将进程看做资源分配的单位，将线程看做调度的单位。

不管是进程还是线程，每次阻塞、切换都需要陷入系统调用，先让 CPU 执行操作系统的调度程序，再由调度程序决定该让哪个进程（线程）继续执行。

- 协程

协程是比线程更轻量的执行单元。**进程、线程的调度是 OS 负责的，而协程则是由执行单元相互协商进行调度的，所以它的切换发生在用户态**。

每个协程都有自己的寄存器上下文和栈，协程在调度切换时，将寄存器上下文和栈保存到其他地方，在切回来时，恢复之前保存的寄存器上下文和栈。

协程的主要特点：占用的资源更少、所有切换和调度都发生在用户态、其调度是协商式的，而不是抢占式。


# Questions

谈谈你对协程的理解。

1. 要明确协程是一种轻量级的执行单元
2. 要从协程调度上入手讲清协程是协作式调度，而不像进程和线程那样的抢占式调度
3. 重点强调协程的切换其本质是依赖于栈的切换，每个协程的上下文都保存在自己的栈上
4. 可以结合 IO 多路复用的接口讲如何使用协程实现高性能的同步 IO
