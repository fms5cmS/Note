# 4.3 数据库范式

要想满足第二范式必须先满足第一范式，要满足第三范式必须先满足第二范式。

1NF：表的每一列都是不可分隔的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或不能有重复的属性。列数据的不可分割；

2NF：表中每个实例或行必须可以被唯一区分。为实现区分通常需为表加上一个列，来储存各个实例的唯一标识。主键；

3NF：表中不包含在其他表中已包含的非主关键字信息。外键。

反三范式，有时候为了效率可以设置重复的字段，适当保留冗余字段。



# 4.4 MySQL建索引

MySQL什么时候适合建索引，什么时候不适合建索引？

- 哪些情况需要创建索引？
  - 主键自动建立唯一索引；
  - 频繁作为查询条件的字段应该创建索引；
  - 查询中与其它表关联的字段，外键关系建立索引；
  - 在高并发下倾向于创建复合索引而不是单值索引；
  - 查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度；
  - 查询中统计或分组字段
- 哪些情况不要创建索引？
  - 表记录太少；
  - 经常增删改的表或字段；
  - `WHERE`条件里用不到的字段不创建索引；
  - 过滤性不好的不适合建索引。
    - 数据重复且分布平均的表字段，如果某个数据列包含许多重复的内容，为它建立索引没有太大的实际效果。

因此应该只为经常查询和最经常排序的数据列建立索引。

索引的选择性是指索引列中不同值的数目与表中记录数的比。如果一个表中有2000条记录，表索引列有1980个不同的值，那么之歌索引的选择性就是$1980/2000=0.99$。一个索引的选择性越接近于1，这个索引的效率就越高。



# 4.5 MySQL删除

delete 和 truncate 对比：

1. `delete`可以加`where`条件，`truncate`不能加；
2. `truncate`删除，效率高一些；
3. 假如要删除的表中有自增长列，如果用`delete`删除后，再插入数据，自增长列的值从断点开始，而`truncate`删除后，再插入数据，自增长列的值从1开始；
4. `truncate`删除没有返回值，`delete`删除有返回值；
5. `truncate`删除不能回滚，`delete`删除可以回滚。



# 4.6 事务

事务的四大特点（ACID） ：

- atomicity（原子性）表示一个事务内的所有操作是一个整体，要 么全部成功，要么全失败；
- consistency（一致性）表示一个事务内有一个操作失败时，所有的更改过的数据都必须回滚到修改前的状态；
- isolation（隔离性） 一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事物是隔离的，并发执行的各个事务之间不能相互干扰。
- durability（持久性）事务完成之后，它对于系统的影响是永久性的，计时系统故障也不会丢失。

事务的隔离级别：

| 隔离级别（√表示会发生该问题）                            | 脏读 | 不可重复读 | 幻读 |
| -------------------------------------------------------- | ---- | ---------- | ---- |
| 读取未提交（Read Uncommitted)                            | √    | √          | √    |
| 读取已提交(Read Committed)（Oracle默认隔离级别，常用！） | ×    | √          | √    |
| 可重复读（Repeatable Read)（MySQL默认隔离级别）          | ×    | ×          | √    |
| 串行（序列）化（serializable)                            | ×    | ×          | ×    |



# 4.7 分页

MySQL的分页是使用关键字`limit`完成分页的。

```sql
-- 语法：offset ：要显示条目的起始索引.起始索引从0开始；rowCount ：要显示的条目个数
select 查询列表  from 表 limit offset , rowCount;

-- 公式：要显示的页数 page，每页的条目数size 
select 查询列表  from 表  limit  (page-1)*size , size;
```



# 4.8 数据库连接池

- 数据库连接池的好处：
  - 资源重用
  - 更快的系统反应速度
  - 新的系统分配手段
  - 统一的连接管理，避免数据库连接泄露。



# 4.9 数据库优化

- 定位：定位慢查询
- 优化手段：
  - 创建索引；
  - 分表：当一张表的数据比较多或一张表的某些字段的值比较多且很少使用时，采用水平分表和垂直分表优化；
  - 读写分离；
  - 缓存：使用Redis来进行缓存



# 4.10 SQL优化

- DDL优化：

  - 通过禁用索引来提供导入数据性能，主要针对有数据的表追加数据：

    ```sql
    -- 去除键
    alter table test3 DISABLE keys;
    -- 批量插入数据
    insert into test3 select * from test
    -- 恢复键
    alter table test3 ENABLE keys;
    ```

  - 关闭唯一校验

    ```sql
    set unique_checkes=0 -- 关闭
    set unique_checkes=1 -- 开启
    ```

  - 修改事务提交方式(导入)

    ```sql
    set autocommit=0 -- 关闭
    # 批量插入
    set autocommit=1 -- 开启
    ```

- DML优化

  ```sql
  insert into test values(1,2)
  insert into test values(1,23)
  insert into test values(1,5)
  -- 将多条插入合并为一条
  insert into test values(1,2),(1,23),(1,5)
  ```

- DQL优化：

  - 见MySQL笔记

