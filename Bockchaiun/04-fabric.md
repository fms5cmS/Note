
[Fabric](https://github.com/hyperledger/fabric) 是 hyperledgr 社区首个项目也是最流行的分布式账本实现，支持通用编程语言编写智能合约（fabric 称为 链码 chaincode）的分布式账本平台。

[Fabric 文档](https://hyperledger-fabric.readthedocs.io/zh_CN/latest/index.html)

与公共非许可网络（如比特币、以太坊）不通，fabric 平台的参与者彼此了解而不是匿名的或完全不信任的，尽管参与者可能不会完全信任彼此（例如，同行业中的竞争对手），但网络可以在一个治理模式下运行，这个治理模式是建立在参与者之间确实存在的信任之上的，如处理纠纷的法律协议或框架。Fabric 网络的成员需要从可信赖的成员服务提供者（MSP）注册

Fabric 平台支持可插拔的共识协议，例如，当部署在单个企业内活由可信任的权威机构管理师，CFT 共识协议可能就够了，而在去中心化场景中，可能需要更传统的 BFT 共识协议。

> 共识协议可以看 [Consistency&Consensus](https://github.com/fms5cmS/arts/blob/master/share/12_consistency%26consensus.md)

Fabric 平台可以利用不需要原生加密货币的共识协议来激励昂贵的挖矿货推动智能合约执行。不使用加密货币会降低系统的风险，且没有挖矿操作意味着可以使用与任何其他分布式系统大致相同的运营成本来部署平台。

Hyperledger Fabric 还提供创建 通道 的功能，允许一组参与者创建各自的交易账本。

> 某些网络中，一些参与者可能是竞争对手，并且不希望他们做出的每笔交易都被每个参与者知晓，例如，他们只向某些参与者提供的特殊价格，而其他人不是。如果两个参与者组成一个通道，那么只有这两个参与者拥有该通道的账本副本，而其他参与者没有。

Fabric 网络中有四种不同种类的服务节点，彼此协作完成整个区块链系统的记账功能：

- Endorser Peer(背书节点)：对交易提案（Transaction Proposal）进行检查，通过执行智能合约计算交易执行结果（读写集合）并对其进行背书；
- Committer Peer(记账节点)：负责维护账本，检查排序后交易结果合法性，接受合法修改，并写入到本地账本结构，目前所有 Peer 默认都是记账节点；
- Orderer(排序节点)：正式交易会发给排序节点，排序节点负责对网络中所有交易进行排序处理，并整理为区块结构，之后被记账节点拉取提交到本地账本；
- CA(证书节点)：提供标准的 PKI 服务，负责对网络中所有的证书进行管理，包括签发和撤销

网络账本的基本单位是通道（Channel），每个通道内的成员可以共享账本，不同通道内账本则彼此隔离。客户端可以向网络内发送交易，交易经过共识后被通道内的 Peer 节点接收并更新本地对应的账本。

# 模块化

Hyperledger Fabric 被设计为模块化结构，由一些模块化组件组成：

- 可插拔的排序服务，对交易顺序建立共识，然后向节点广播区块
- 可插拔的成员服务提供者，负责将网络中的实体与加密身份相关联
- 可选的 P2P gossip 服务，通过排序服务将区块发送到其他节点
- 智能合约（链码）隔离运行在容器环境中，链码可以使用标准编程语言编写，但不能直接访问账本状态
- 账本可以通过配置来支持不通的 DBMS
- 可插拔的背书和验证策略，每个应用程序可以独立配置

# 交易流

不同于[顺序执行架构](./01-blockchain.md#顺序执行架构)，Fabric 引入了一种新的架构：**执行-排序-验证**，在交易顺序达成最终一致前就执行交易。为了解决顺序执行模型面临的弹性、灵活性、可伸缩性、性能和机密性问题，将交易流分为三个步骤：

1. 执行一个交易并验证其正确性，从而给它背书
2. 通过（可插拔的）共识协议将交易排序
3. 提交交易到账本前先根据特定应用程序的背书策略验证交易

在 Fabric 中，特定应用程序的背书策略可以指定需要哪些节点或多少节点来保证给定的智能合约正确执行。因此，每个交易只需要由满足交易的背书策略所必需的节点的子集来执行（背书）。这样可以并行执行，从而提高系统的整体性能和规模。第一阶段也消除了任何非确定性，因为在排序之前可以过滤掉不一致的结果。

因为消除了非确定性，Fabric 是第一个能使用标准编程语言的区块链技术。

# 共享账本

Fabric 有一个账本子系统，包括两个组件：世界状态和交易日志。每个参与者都拥有他们所属的每个 Fabric 网络的账本副本。

- 世界状态组件描述了在给定时间点的账本的状态，它是账本的数据库
  - 账本中世界状态的数据存储是可替换的。默认情况下，这是 LevelDB 键值存储数据库
- 交易日志组件记录产生世界状态中当前值的所有交易，这是世界状态的更新历史
  - 交易日志不需要是可插拔的，它只记录区块链网络使用账本数据库前后的值

# 隐私和保密性

Fabric 中的隐私和保密性主要通过通道（Channel）架构和 私有数据 来保障：

- 在通道方面，Fabric 网络中的成员组建了一个子网络，在子网络中的成员可以看到其所参与到的交易
  - 因此，参与到通道的节点才有权访问智能合约（链码）和交易数据，以此保证了隐私性和保密性
- 私有数据通过在通道中的成员间使用集合，实现了和通道相同的隐私能力并且不用创建和维护独立的通道
