
[Fabric](https://github.com/hyperledger/fabric) 是 hyperledgr 社区首个项目也是最流行的分布式账本实现，支持通用编程语言编写智能合约（fabric 称为 链码 chaincode）的分布式账本平台。

> [官方文档](https://hyperledger-fabric.readthedocs.io/en/latest/whatis.html) 左下角选择版本和语言

# 许可区块链

非许可区块链几乎任何人都可以参与，每个参与者都是匿名的。在区块链状态达到不可变的区块深度前不存在信任。为了弥补这种信任的缺失，非许可区块链通常采用“挖矿”或交易费来提供经济激励，以抵消参与基于“工作量证明（PoW）”的拜占庭容错共识形式的特殊成本。

许可区块链在一组已知的、已识别的且经常经过审查的参与者中操作区块链，这些参与者在产生一定程度信任的治理模型下运作。

通过依赖参与者的身份，许可区块链可以使用更传统的崩溃容错（CFT）或拜占庭容错（BFT）共识协议，而不需要昂贵的挖掘。

在许可的情况下，降低了参与者故意通过智能合约引入恶意代码的风险。首先，参与者彼此了解对方以及所有的操作，无论是提交交易、修改网络配置还是部署智能合约都根据网络中已经确定的背书策略和相关交易类型被记录在区块链上。与完全匿名相比，可以很容易地识别犯罪方，并根据治理模式的条款进行处理。

Fabric 网络的成员需要从可信赖的成员服务提供者（MSP）注册！

# 模块化

- 插件化的排序服务：对交易顺序建立共识，然后向其他 peers 广播
- 插件化的成员服务提供者：负责将网络中的实体与加密身份相关联
- 可选的 P2P gossip 服务：通过排序服务将区块发送到其他 peers
- 隔离运行在容器环境的智能合约（chaincode，链码）：可用标准编程语言编写，但不能直接访问账本状态
- 可配置的账本：用于支持多种 DBMS
- 插件化的背书和验证策略（endorsement and validation policy ）：每个应用可单独配置

# 链码（智能合约）

不同于多数区块链平台的[顺序执行架构](../Bockchaiun/01-blockchain.md#顺序执行架构)，Fabric 引入了一种新的交易架构：**执行-排序-验证（ execute-order-validate）**，它将交易流分为三个步骤：

1. 执行一个交易并验证其正确性，从而给它背书
   1. 消除了非确定性，所以可以使用辨准编程语言编写
2. 通过（可插拔的）共识协议将交易排序
3. 提交交易到账本前先根据特定应用程序的背书策略验证交易

因此，Fabric 在交易顺序达成最终一致前就已经执行了交易。

由于特定应用的背书策略可以指定哪些或多少节点来保证给定链码的正确执行，因此，每笔交易只需要由满足背书策略所必需的节点的子集来执行（背书）。这样，就可以并发执行，从而提高系统整体的性能和规模。

# 隐私和保密性

Fabric 中的隐私和保密性主要通过通道（Channel）架构和 私有数据 来保障：

- 在通道方面，Fabric 网络中的成员组建了一个子网络，在子网络中的成员可以看到其所参与到的交易
  - 因此，参与到通道的节点才有权访问智能合约（链码）和交易数据，以此保证了隐私性和保密性
- 私有数据通过在通道中的成员间使用集合，实现了和通道相同的隐私能力并且不用创建和维护独立的通道

# 插件化的共识

插件化的排序服务，在逻辑上与执行交易和维护账本的节点解耦，可以对交易顺序建立共识。共识可以根据特定部署或解决方案的信任假设来定制其实现，允许平台依赖完善的工具包进行 CFT（崩溃容错）或 BFT（拜占庭容错）的排序。

Fabric 目前提供了一种基于 etcd 库 中 [Raft 协议](https://raft.github.io/raft.pdf) 的 CFT 排序服务的实现。

> 共识协议的简单说明可以看 [Consistency&Consensus](https://github.com/fms5cmS/arts/blob/master/share/12_consistency%26consensus.md)

# 共享账本

Fabric 有一个账本子系统，包括两个组件：世界状态和交易日志。每个参与者都拥有他们所属的每个 Fabric 网络的账本副本。

- 世界状态组件描述了在给定时间点的账本的状态，它是账本的数据库
  - 账本中世界状态的数据存储是可替换的。默认情况下，这是 LevelDB 键值存储数据库
- 交易日志组件记录产生世界状态中当前值的所有交易，这是世界状态的更新历史
  - 交易日志不需要是可插拔的，它只记录区块链网络使用账本数据库前后的值

# 部分说明

- 资产

Fabric 中的资产表示为键值对的集合，状态更改记录为 Channel 账本上的交易。资产可以用二进制或 JSON 表示。

- 链码

链码强制执行读取或更改键值对或其他状态数据库信息的规则。

链码函数针对账本的当前状态数据库执行，并通过交易提案启动。链码执行会产生一组用于写入的键值对（写集），可以被提交到网络并应用于所有节点的账本。

- 账本

账本由区块链（“链”）组成，用于以区块的形式存储不可变的顺序记录，以及用于维护当前 Fabirc 状态的状态数据库。它是 Fabric 中所有状态转换的有序的防篡改的记录。

状态转换是参与方提交的链码调用（“交易”）的结果。

每笔交易都会生成一组资产键值对，这些键值对以创建、更新或删除形式提交到账本。

- 隐私

每个 Channel 有一个账本。每个节点为其所属的每个通道维护一个账本的副本。

Channel 在更广泛的网络上保证交易的私密性，而集合则在 Channel 上的组织子集间保持数据的私密性！

账本可以在整个网络中共享（每个参与者在同一个公共 Channel 上），也可以被私有化（仅包含一组特定的参与者）。

当该 Channel 上的组织子集需要对其交易数据保密时，私有数据集合用于将此数据隔离在私有数据库中，在逻辑上与 Channel 账本分开，只有经授权的组织子集才能访问。

为了进一步模糊数据，在将交易发送到排序服务并将区块附加到账本之前，可以使用诸如 AES 之类的通用加密算法对链码内的值进行加密（部分或全部）。一旦加密数据被写入账本，它就只能由拥有用于生成密文的相应密钥的用户解密。

- 安全和成员服务

Fabric 支持一个交易网络，在这个网络中，所有参与者都拥有已知的身份。
