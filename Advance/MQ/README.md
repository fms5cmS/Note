[消息队列](../Architecture/03-消息队列.md)

# 引入MQ后如何高可用

RabbitMQ的高可用：基于主从做高可用性的。RabbitMQ 有三种模式：
- 单机
- 普通集群：在多台机器上启动多个RabbitMQ实例，每个机器启动一个。但是你、创建的queue，只会放在一个RabbitMQ实例上，每个实例都同步queue的元数据。消费时，如果连接到了另外一个实例，那么那个实例会从queue所在实例上拉取数据过来。获取数据的两种方式：
  - 消费者每次随机连接一个实例然后拉取数据==>数据拉取的开销
  - 固定连接那个queue所在实例消费数据==>导致单实例性能瓶颈
- 镜像集群：创建的queue，无论元数据还是queue里的消息都会存在于多个实例上，然后每次写消息到queue的时候，都会自动把消息到多个实例的queue里进行消息同步。
  - 性能开销大，消息同步所有机器，导致网络带宽压力和消耗很重；
  - 开启：在管理控制台新增一个镜像集群模式的策略。指定的时候可以要求数据同步到所有节点的，也可以要求就同步到指定数量的节点，然后你再次创建queue的时候，应用这个策略，就会自动将数据同步到其他的节点上去了。



# 保证消息顺序性

RabbitMQ：拆分多个queue，每个queue一个consumer，就是多一些queue而已，确实是麻烦点；或者就一个queue但是对应一个consumer，然后这个consumer内部用内存队列做排队，然后分发给底层不同的worker来处理

# 对比多款MQ

以下四种 MQ 都支持消息事务，客户端将信道设置为事务模式，只有当消息被rabbitMq接收，事务才能提交成功，否则在捕获异常后进行回滚。使用事务会使得性能有所下降。

| 特性       | RabbitMQ                     | RocketMQ                        | ActiveMQ                           | Kafka                                                                        |
| ---------- | ---------------------------- | ------------------------------- | ---------------------------------- | ---------------------------------------------------------------------------- |
| 消息存储   | 内存、磁盘。支持少量堆积。   | 磁盘。支持大量堆积。            | 内存、磁盘、数据库。支持少量堆积。 | 内存、磁盘、数据库。支持大量堆积。                                           |
| 单机吞吐量 | 万级                         | 10万级                          | 万级                               | 10万级别，吞吐量高。一般配合大数据类的系统来进行实时数据计算、日志采集等场景 |
| 时效性     | 微秒级                       | ms级                            | ms级                               | ms级                                                                         |
| 可用性     | 高，基于主从架构实现高可用性 | 非常高（分布式）                | 高（主从）                         | 非常高（分布式）                                                             |
| 消息可靠性 |                              | 经过参数优化配置，可以做到0丢失 | 有较低的概率丢失数据               | 经过参数优化配置，消息可以做到0丢失                                          |
| 顺序消息   | 不支持                       | 支持                            | 不支持                             | 支持                                                                         |

- ActiveMQ：非常成熟，功能强大，在业内大量的公司以及项目中都有应用，偶尔会有较低概率丢失消息。主要是基于解耦和异步来用的，较少在大规模吞吐的场景中使用。
- RabbitMQ：erlang语言开发，性能极其好，延时很低；吞吐量到万级，MQ功能比较完备，开源社区活跃，
- RocketMQ：接口简单易用，可以做到大规模吞吐，性能也非常好，分布式扩展也很方便，社区维护还可以，可靠性和可用性都是ok的，还可以支撑大规模的topic数量，支持复杂MQ业务场景。
- Kafka：仅提供较少的核心功能，但是提供超高的吞吐量，ms级的延迟，极高的可用性以及可靠性，而且分布式可以任意扩展，同时kafka最好是支撑较少的topic数量即可，保证其超高吞吐量。

# MQ 基本概念

- 消息服务的两个重要概念：
  - 消息代理（message broker），即消息中间件的服务器
  - 目的地（destination）
  - 当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地。
- 消息队列主要有**两种形式的目的地**：
  - 队列（queue）：点对点消息通信（point-to-point）
    - 发送者发送消息，消息代理将其放入一个队列中，接收者从队列中获取消息内容，消息读取后被移出队列
    - 消息只有唯一的发送者和接受者，但可有多个接收者。eg：A、B、C都可接收消息，但一旦A接受了消息，B、C就接受不到消息了
  - 主题（topic）：发布（publish）/订阅（subscribe）消息通信
    - 发送者（发布者）发送消息到主题，多个接收者（订阅者）监听（订阅）这个主题，那么就会在消息到达时同时收到消息
- 两个常见的消息服务规范：
  - JMS(Java Message Service)：基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现
  - AMQP（Advanced Message Queuing Protocol）：高级消息队列协议，兼容JMS。RabbitMQ是AMQP的实现

|              | JMS                                                                                                                             | AMQP                                                                                                                                                                                                                                                                             |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 定义         | Java   api                                                                                                                      | 网络线级协议                                                                                                                                                                                                                                                                     |
| 跨语言       | 否                                                                                                                              | 是                                                                                                                                                                                                                                                                               |
| 跨平台       | 否                                                                                                                              | 是                                                                                                                                                                                                                                                                               |
| Model        | 提供两种消息模型：<br/>Peer-2-Peer（点对点）<br/>Pub/sub（发布订阅）                                                            | 提供了五种消息模型：<br/>direct   exchange（点对点） <br/>fanout   exchange（发布订阅） <br/>topic   change（发布订阅）<br/>headers   exchange（发布订阅）<br>system   exchange（发布订阅）<br/>本质来讲，后四种和JMS的pub/sub模型没有太大差别，仅是在路由机制上做了更详细的划分 |
| 支持消息类型 | 多种消息类型：   TextMessage   MapMessage   BytesMessage   StreamMessage   ObjectMessage   Message   （只有消息头和属性）       | byte[]   当实际应用时，有复杂的消息，可以将消息序列化后发送。                                                                                                                                                                                                                    |
| 综合评价     | JMS   定义了JAVA   API层面的标准；在java体系中，多个client均可以通过JMS进行交互，不需要应用修改代码，但是其对跨平台的支持较差； | AMQP定义了wire-level层的协议标准；天然具有跨平台、跨语言特性。                                                                                                                                                                                                                   |

- Spring支持：
  - spring-jms提供了对JMS的支持
  - spring-rabbit提供了对AMQP的支持
  - 需要`ConnectionFactory`的实现来连接消息代理
  - 提供`JmsTemplate`、`RabbitTemplate`来发送消息
  - `@JmsListener`（JMS）、`@RabbitListener`（AMQP）注解在方法上监听消息代理发布的消息
  - `@EnableJms`、`@EnableRabbit`开启支持
- SpringBoot自动配置
  - `JmsAutoConfiguration`
  - `RabbitAutoConfiguration`

