记日志通常有两个主要目的：定位问题和事件确认

日志种类：错误日志、业务日志、访问日志（记录每一次请求的请求方法、方法调用开始/结束时间、方法响应结果、状态码，还会记录 RequestId、TraceId、SpanId 等附加属性，以达到日志链路追踪得效果）

# 日志记录指导原则

## 保持适度

切勿记录过多，也不可记录过少！

记录了太多，就还需要设计出复杂的方法来减少磁盘访问、保留历史记录、归档大量数据、以及在这些数据中查询；

如果日志不能明确一个 bug 的原因，或者某个事务是否执行，说明日志记录的过少了。

- 适合记录的：
  - 重要启动配置
  - 错误
  - 警告
  - 性数据的更改
  - 系统组件间的请求和响应
  - 的状态变化
  - 交互
  - 知失败风险的调用
  - 时间的等待
  - 运行任务的周期性进度
  - 的逻辑分支和导向分支的条件
  - 层方法来汇总处理流程的步骤和事件——避免在底层方法中记录复杂流程的每一步骤
- 适合记录的：
  - 方法入口 —— 不要记录方法入口，除非它非常重要或者是日志处于调试级别。
  - 循环中的数据 —— 避免在循环的多次迭代中记录日志。如果是小循环，或者是间歇性的记录，倒也无妨。
  - 大消息或者文件的内容——截断或者使用一些有利于调试的方式进行汇总。
  - 良性错误 —— 那些不是真正错误的错误会令日志的读者感到困惑。当异常处理是执行成功的一部分时，有时会遇到这种情况。
  - 重复的错误 —— 不要重复的记录相同或者相似的错误。这样可能会快速的填满日志，并且隐藏掉真正的问题。各种类型错误发生的频率最好有监视器（monitor）处理。日志只需捕获问题的详细信息。

## 多个日志级别

一般会有如下级别：

- Debug —— 最详细，但是只有在开发或者调试时适用。
- Info —— 最常用的级别。
- Warning —— 陌生的或者不在预期之内的一些状态，但是可接受。
- Error —— 有错误发生，但是流程不受影响。
- Fatal/Critical —— 流程无法继续，系统将关闭或者重启。

实际中，一般日志配置分两种场景：

- 生产环境 —— 除了调试级别，其他全开。
  - 如果生产环境发生了问题，日志应该能够指明原因。
- 开发和调试 —— 编写新代码或是尝试复现问题时，打开全部级别。

## 测试日志也很重要

日志的质量对于测试代码和产品代码同样重要。当一次测试运行失败时，日志应当明确的指出这个错误是来自测试本身还是生产系统。如果做不到这一点，那么测试的日志是有问题的。

- 测试日志应该必需包括：
  - 测试执行环境
  - 初始状态
  - 准备步骤
  - 用例步骤
  - 与系统的交互
  - 期望的结果
  - 实际的结果
  - 清理步骤
  - 利用临时日志队列实现条件性的详细信息控制

发生错误时，日志应当包含大量的详细信息。但不幸的是，当遇到一个错误时，导致这个错误发生的详细信息可能已经无法获得了。如果你听从了“不要记录过多”的建议，在错误日志之前的那些日志可能无法提供足够的细节。

解决这个问题的一个好的方式是，在内存中创建临时的日志队列。在事务的处理过程中，将每一步的详尽信息追加到队列中。如果事务成功完成，丢弃这个队列，只记录一个汇总。如果发生了错误，就把错误和队列里的全部内容记录下来。这一方法对于系统交互的日志尤其有效。

## 记录性能数据

记录时间数据可以用来帮助定位性能问题。例如，要找到一个大型系统的超时原因是很困难的，除非你能够追踪每一个重要处理步骤的耗时情况。这是很容易做到的，只需记录那些可能会比较耗时的调用的开始和结束时间即可：

- 重要的系统调用
- 网络请求
- CPU 密集运算
- 连接设备的交互
- 事务

## 多线/进程

在涉及到多线程或多进程的处理时，要为事务创建独一的标识。事务初始化时创建 ID，将它传入每一个为此事务工作的部分。

当记录关于此事务的日志时，每一个部分都应该记录下这个 ID。这样，在多个事务并行执行时，追踪一个特定的事务会容易很多。

## 监控+日志

一个生产服务应该既有日志也有监控。

监控提供了一种实时的对于系统状态的统计汇总。可以提醒你，是否一定比例的某个类型请求失败了，是否系统正在经受不正常的流量访问，性能是否在下降，或者其他的一些异常。在某些情况下，只是这些信息就可以为找到问题原因提供线索。

不过，大多数情况下，监控警报只是为了简单的触发你的调查。监控将问题的症状展现给我们。日志则针对各个事务提供了详细的信息和状态，这样你才能全面的理解问题的原因。

# Back-Pressure

网络日志服务很容易出连接失败和背压情况，这会导致日志消息丢失，有时甚至会导致服务失败。解决方案：**建立一个缓冲数据的更有弹性的日志记录器**。

前置知识：TCP 的三次握手，接收方每次收到消息后都向发送方确认消息。

日志服务器的背压场景：日志服务器很短时间内从众多客户端收到了很多的消息，随着这些消息的进入，日志服务器可能慢下来，虽然日志服务器减速了，但进入服务器的日志数量并没有减少。由于采用了 TCP，日志服务器必须为每个新消息发送确认信息，当日志服务器延迟了发送确认消息，那么客户端就只能等待，所以客户端也必须慢下来。

解决方案：TCP 转为 UDP，这样，用户就能摆脱协议级别的连接开销，且应用程序不需要等待来自日志服务器的 Ack 消息。

使用 UDP 协议：

- 优点：
  - 抑制背压和日志服务器的停机。如果日志服务器发生停机，可能会失去一些 UDP 数据包，但客户不会受影响
  - 即使没有背压，发送日志也很快
- 缺点：
  - 日志消息容易丢失
  - 日志消息不按顺序来接收。较大的日志消息可能先进行压缩，然后混乱地传输。
    - 添加时间戳到消息上有所帮助，但无法完全解决该问题
