在 MySQL 数据表设计中，一般有这么一个原则：如果存在大字段数据，而且它一般不变，应该将不变的字段单独放入另外一个表中。

CentOS 7 下 MySQL 的 YUM 安装方式：可以查看：[官方文档](https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/)

在 MySQL 的命令行输入`show variables like 'character%'`查看字符集，下表是 8.0 的默认字符集。

![](../images/MySQL-character.jpg)

MySQL 的配置文件：Windows 中是 my.ini；Linux 中是`/etc/my.cnf`，主要的配置：

- 二进制日志 log-bin：主要用于主从复制。
- 错误日志 log-error：默认关闭，记录严重的警告和错误信息，每次启动和关闭的详细信息等。
- 查询日志 log：默认关闭，记录查询的 sql 语句，如果开启会降低 mysql 的整体性能，因为记录日志也需要消耗系统资源。
- 数据文件：
  - .frm 文件：存放表结构
  - .myd 文件：存放表数据
  - .myi 文件：存放表索引

注意：mysqld 是服务端程序；mysql 是命令行客户端程序。

# 逻辑架构

![逻辑架构](../images/MySQL-logic.png)

MySQL 的架构（上图所示）可以在多种不同场景中应用并发挥良好作用。主要体现在存储引擎的架构上，插件式的存储引擎架构将查询处理和其他的系统任务及数据的存储提取相分离。这种架构可以根据业务的需求和实际需求选择合适的存储引擎。可以看出，整个 MySQL 被分成四层：

1. 连接层

   最上层是一些客户端和连接服务，包含本地 Socket 通信和大多数基于客户端/服务端工具实现的类似于 TCP/IP 的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于 SSL 的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。

2. 服务层

   第二层架构主要完成大多数的核心服务功能，如 SQL 接口，并完成缓存查询，SQL 的分析和优化及部分内置函数的执行，所有跨存储引擎的功能也在这一层实现，如过程，函数等，在该层，服务层会解析查询并创建相应的内部解析树，并对其完成相应的优化，如确认查询表的顺序，是否利用索引等，最后生成相应的执行操作，如果是`select`语句，服务器还会查询内部的缓存，如果缓存空间足够大，这样就解决大量读操作的环境中能够很好的提供系统性能。

3. 引擎层

   存储引擎层，存储引擎真正的负责了 MySQL 中数据的存储和提取，服务器通过 API 与存储引擎进行通信，不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取，例如：MyISAM 和 InnoDB。

4. 存储层

   数据存储层，主要将数据存储在运行于裸设备的文件系统之上。并完成存储引擎的交互。

# 存储引擎

MySQL 中存储引擎的主要作用是负责数据的存储和提取，MySQL 的默认存储引擎 InnoDB 使用的是 B+ 树来存储数据。

MySQL 中用的最多的存储引擎：`innodb`、`myisam`、`memory` 等。其中`innodb`支持事务，而`myisam`、`memory`等不支持事务。

```sql
-- 查看MySQL所支持的的存储引擎
show engines;
-- 查看MySQL当前默认的存储引擎
show variables like '%storage_engine%';
```

![命令查看存储引擎](../images/MySQL-engines.png)

主要的两种存储引擎的区别：

|        | MyISAM                                                         | InnoDB                                                                    |
| ------ | -------------------------------------------------------------- | ------------------------------------------------------------------------- |
| 主外键 | 不支持                                                         | 支持                                                                      |
| 事务   | 不支持                                                         | 支持                                                                      |
| 行表锁 | 表锁<br>即使操作一条记录也会锁住整个表。<br>不适合高并发操作。 | 行锁。<br>操作时只锁住某一行，不对其它行有影响。<br/>**适合高并发操作**。 |
| 缓存   | 只缓存索引，不缓存真实数据                                     | 同时缓存索引、真实数据，对内存要求较高，<br>且内存大小对性能有决定性影响  |
| 表空间 | 小                                                             | 大                                                                        |
| 关注点 | 性能                                                           | 事务                                                                      |

InnoDB 存储引擎还有个“自适应 Hash 索引”的功能，就是当某个索引值使用非常频繁的时候，它会在 B+ 树索引的基础上再创建一个 Hash 索引，这样让 B+ 树也具备了 Hash 索引的优点。

InnoDB 三大关键特性：插入缓冲（Insert Buffer）、二次写(Double Write)、自适应 Hash。

# 数据库调优

数据库调优的目的就是要让数据库运行得更快，也就是说响应的时间更快，吞吐量更大。

数据库调优的选择维度：

- 选择合适的 RDBMS
  - 对事务性处理以及安全性要求高的话，可以选择商业的数据库产品。
- 优化表的设计
- SQL 查询优化
  - 逻辑查询优化：通过改变 SQL 语句让 SQL 执行效率更高效，采用的方式是对 SQL 语句进行等价变换，对查询进行重写。
  - 物理查询优化：将逻辑查询的内容变成可以被执行的物理操作符，从而为后续执行器的执行提供准备。
    - 核心是高效地建立索引，并通过这些索引来做各种优化。
- 使用 Redis 或 Memcached 作为缓存
- 库级优化
  - 控制一个库中的数据表数量、采用主从架构优化读写策略、分库分表

# 数据导入/出

## 导出

- into outfile 导出：

在 my.ini 文件中设置`secure-file-priv=""`，就可以将导出文件放置在任意位置。

```sql
select * from user
	into outfile '/tmp/user.csv' -- 指定导出目录和文件名(该文件必须是不存在的)
	fields terminated by ','  -- 定义字段间的分隔符
	optionally enclosed by '"'  -- 定义包围字段的字符（数值型字段无效）
	lines terminated by '\r\n'; -- 定义每行的分隔符
```

注意：输出不能是一个已存在的文件，防止文件数据被篡改。

---

- 导出表作为原始数据：

`mysqldump`是 MySQL 用于转存储数据库的实用程序。主要产生一个 SQL 脚本，其中包含从头重新创建数据库所必需的命令 `CREATE TABLE` `INSERT`等。

使用`mysqldump`导出数据需要使用`--tab`选项来指定导出文件指定的目录，该目标必须是可写的。

在 MySQL 的安装目录下的 bin 目录进入命令行（不要进入数据库终端），执行：

```sql
mysqldump -u用户名 -p 数据库 要导出的表 > 文件目录和文件名
-- 如：mysqldump -uroot -p ssm_crud tbl_emp > d:\s.sql
```

如果要导出整个数据库的数据：`mysqldump -u用户名 -p 数据库名 > data.txt`

如果要导出所有数据库：`mysqldump -u用户名 -p --all-databases > data.txt`

## 导入

- mysql 命令导入

```sql
mysql -u用户名 -p < 要导入的数据库数据
-- 如：mysql -uroot -p < s.sql
```

---

- source 命令导入

登录到数据库终端——>创建数据库——>使用该数据库——>输入：`source 文件`。

如：`source d:\s.sql`

---

- load data 命令导入

```sql
load data [local] infile '文件' into table 表名;
-- 使用了 local 关键字，则从客户主机上按路径读取文件
-- 不使用，则文件在服务器上按路径读取文件
```

也可以像`into outfile`命令那样指定分隔符，使用相同：

- `fields terminated by ‘字段间分隔符’`：定义字段间的分隔符
- `lines terminated by ‘行间分隔符’`：定义每行的分隔符

`LOAD DATA`默认情况下是按照数据文件中列的顺序插入数据的，如果数据文件中的列与插入表中的列不一致，则需要指定列的顺序。如，在数据文件中的列顺序是 a,b,c，但在插入表的列顺序为 b,c,a，则数据导入语法如下：

```sql
LOAD DATA LOCAL INFILE 'dump.txt' INTO TABLE mytbl (b, c, a);
```

---

- mysqlimport 命令导入

在 MySQL 的安装目录下的 bin 目录下进入命令行(不用进数据库终端)，执行：

```sql
mysqlimport -u用户名 -p --local 数据库名 文件
```

可使用`--column`选项设置列的顺序，如：

```shell
mysqlimport -u root -p --local --columns=b,c,a database_name dump.txt
```
