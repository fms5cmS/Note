# 事务

事务的四大特点（ACID） 

- atomicity（原子性）表示一个事务内的所有操作是一个整体，要 么全部成功，要么全失败；
- consistency（一致性）表示一个事务内有一个操作失败时，所有的更改过的数据都必须回滚到修改前的状态；
- isolation（隔离性） 一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事物是隔离的，并发执行的各个事务之间不能相互干扰。
- durability（持久性）持久性事务完成之后，它对于系统的影响是永久性的。



---

在 MySQL 中用 `show variables like 'autocommit'` 查看自动提交的值

- 创建：

隐式事务：事务没有明显的开启和结束的标记。如`insert`、`update`、`delete`；

显式事务：事务有明显的开启和结束的标记（前提：**必须先设置自动提交功能为禁用，即 `set autocommit=0`，该设置仅针对当前事务有效**）

步骤：

```sql
-- 步骤1：开启事务
set autocommit=0;
start transaction;  #可选的

-- 步骤2：编写事务中的sql语句(select insert update delete)

语句1;
语句2;
...

-- 步骤3：结束事务（提交或回滚 二选一）
commit; 提交事务
rollback;回滚事务
```

- 回滚

```sql
SET autocommit=0;
START TRANSACTION;
DELETE FROM account WHERE id=25;
SAVEPOINT a; -- 设置保存点，只搭配回滚使用
DELETE FROM account WHERE id=28;
ROLLBACK TO a;  -- 回滚到保存点
```



# 隔离级别

对于同时运行的多个事务，当这些事务访问数据库中相同的数据时，如果没有采取必要的隔离机制，会导致并发问题： 

- 更新丢失：当两个事务选择同一行，然后基于最初选定值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题——最后的更新覆盖了其他事务所做的更新。如果在一个程序员完成并提交事务之前，另一个程序员不能访问同意文件，即可避免此问题；
- 脏读：有两个事务T1、T2，T1读取了已经被T2更新但还没有被提交的字段，之后，若T2回滚，T1读取的内容就是临时且无效的。即读到了其他事物修改了的数据；
- 不可重复读（即 原始读取不可重复）：有两个事务T1、T2，T1读取了一个字段，然后T2更新了该字段，之后，T1再次读取同一个字段，值就不同了；重点在 UPDATE 和 DELETE
- 幻读：有两个事务T1、T2，T1从一个表中读取了一个字段，然后T2在该表中插入一些新的行，之后，如果T1再次读取同一个表就会多出几行。重点在 INSERT。 即读到了其他事务新增的数据。

 脏读要一定避免！



事务隔离级别从低到高：

- 读取未提交（Read Uncommitted)：允许事务读取未被其他事务提交的变更。脏读、不可重复读和幻读都会出现。
- 读取已提交(Read Committed)：只允许事务读取已被其他事务提交的变更，可以避免脏读，但不可重复读和幻读仍会出现。
- 可重复读（Repeatable Read)：确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其他事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读仍存在。
- 序列化（serializable)：确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作，多数并发问题都可避免，但性能十分低下。 

| 隔离级别（√表示会发生该问题） | 脏读 | 不可重复读 | 幻读 |
| :---------------------------: | :--: | :--------: | :--: |
| 读取未提交（Read Uncommitted) |  √   |     √      |  √   |
|  读取已提交(Read Committed)   |  ×   |     √      |  √   |
|  可重复读（Repeatable Read)   |  ×   |     ×      |  √   |
| 串行（序列）化（serializable) |  ×   |     ×      |  ×   |

Oracle 支持2种事务隔离级别：`Read committed`、`serializable`。默认的事务隔离级别是`Read committed`；

MySQL 支持4种事务隔离级别，默认的事务隔离级别是 Repeatable Read。 可以直接在 MySQL 中修改隔离级别，而不用在程序中修改。 

每启动一个MySQL程序，就会获得一个单独的数据库连接，每个数据库连接都有一个全局变量`@@tx——isolation`，表示当前的事务隔离级别，MySQL默认的隔离级别是`Repeatable Read`。 

- 在命令行下

  ```sql
  -- 查看隔离级别
  select @@tx_isolation;
  -- 设置隔离级别
  set session|global transaction isolation level 隔离级别;
  ```

